---
title: "空间广义线性模型"
subtitle: "代码实现"
author: "黄湘云"
date: "2018年3月"
geometry: margin=1.18in
fontsize: 12pt
linestretch: 1.5
links-as-notes: yes
documentclass: ctexbook
output: 
  bookdown::pdf_book:
   latex_engine: xelatex
   citation_package: natbib
   number_sections: yes
   keep_tex: no
   toc_depth: 4
   toc_unnumbered: yes
   toc_appendix: yes
   toc_bib: yes
   base_format: rticles::ctex
   pandoc_args: "--top-level-division=chapter"
header-includes: 
   - \renewcommand{\sfdefault}{phv} 
   - \ctexset{ chapter/name = {,}, 
               chapter/number = \arabic{chapter}, 
               chapter/numberformat = \sf, 
               chapter/fixskip = true, 
            }
bibliography: refer.bib
biblio-style: apalike
biblio-title: 参考文献
link-citations: yes
colorlinks: yes
classoption: "hyperref, a4paper, oneside, UTF8, zihao = -4, linespread = 1.3"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = TRUE,
  out.width = "70%",
  fig.align = 'center',
  fig.width = 6,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
  # highlight = FALSE
)
```

# 贝叶斯框架

## 简单分层模型

考虑分层模型，以 8schools 数据集为例^[<http://mc-stan.org/users/documentation/case-studies/divergences_and_bias.html>]
$$\mu \sim \mathcal{N}(0, 5)$$ 
$$\tau \sim \text{Half-Cauchy}(0, 5)$$
$$\theta_{n} \sim \mathcal{N}(\mu, \tau)$$
$$ y_{n} \sim \mathcal{N}(\theta_{n}, \sigma_{n})$$
其中 $n \in \left\{1, \ldots, 8 \right\}$，$\left\{ y_{n}, \sigma_{n} \right\}$ 是已知数据

```{r}
# stan 表示的模型
writeLines(readLines("code/stan/8schools.stan"))
```
```{r}
library(rstan)
options(mc.cores = 2) # 两个线程
rstan_options(auto_write = TRUE)
```

加载数据

```{r}
schools_dat <- list(J = 8, 
                    y = c(28,  8, -3,  7, -1,  1, 18, 12),
                    sigma = c(15, 10, 16, 11,  9, 11, 10, 18))
```

加载模型

```{r}
fit <- stan(file = 'code/stan/8schools.stan', data = schools_dat, 
            iter = 1000, chains = 4, seed = 483892929, refresh = 1200)
```

模型输出

```{r}
print(fit)
```


```{r stan-demo, echo = FALSE, fig.cap = "迭代过程/参数分布/诊断图"}
knitr::include_graphics(path = "figures/demo.png")
```




## 泊松

## 二项

# 程序实现

## *PrevMap* 包

[@PrevMap2017JSS] 将 MCML 和 MCMC 方法应用于空间广义线性混合效应模型的参数估计和预测，

## *geoR* 与 *geoRglm* 包

## Stan 框架

[Stan](http://mc-stan.org/) 是一种概率编程语言[@Stan2017JSS]，可以替代 BUGS ( **B**ayesian inference **U**sing **G**ibbs **S**ampling ) [@BUGS] 作为 MCMC 的高效实现，可用于贝叶斯框架下，标准地统计模型的参数估计，Stan 提供多种语言的接口实现，方便起见，本文采用它提供的 R 语言接口 -- rstan 包 [@RStan]。  　 
基于 GPU 加速是一个不错的选择， Stan 开发者也把 GPU 加速列入开发日程。scikit-cuda [@scikitcuda2015] ArrayFire [@ArrayFire2015] 等基于 CUDA 开发的通用加速框架获得越来越多的关注。类似 Stan 的编程框架还有 PyMC 框架







## R 进程信息

```{r}
sessionInfo()
```

斜体用于扩展包和框架，如 *knitr*、*PrevMap*、*CUDA*、*Stan* 等，粗体用于软件，如 **R**、**Python** 等，等宽体用于代码和代码块。


\cleardoublepage