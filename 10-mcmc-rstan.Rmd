# 贝叶斯与 MCMC {#bayes}

```{r setup, include = FALSE}
source("common.R")
```

## 贝叶斯计算

### MCMC

最大后验估计，贝叶斯分层模型

### pystan

```python
# 整合 Python 语言到 R Mrakdown 
import pystan
import numpy as np
import matplotlib.pyplot as plt

schools_code = """
data {
  int<lower=0> J; // number of schools
  real y[J]; // estimated treatment effects
  real<lower=0> sigma[J]; // s.e. of effect estimates
}
parameters {
  real mu;
  real<lower=0> tau;
  real eta[J];
}
transformed parameters {
  real theta[J];
  for (j in 1:J)
  theta[j] = mu + tau * eta[j];
}
model {
  eta ~ normal(0, 1);
  y ~ normal(theta, sigma);
}
"""

schools_dat = {'J': 8,
  'y': [28,  8, -3,  7, -1,  1, 18, 12],
  'sigma': [15, 10, 16, 11,  9, 11, 10, 18]}

sm = pystan.StanModel(model_code = schools_code)
fit = sm.sampling(data = schools_dat, iter = 1000, chains = 4)

print(fit)

eta = fit.extract(permuted=True)['eta']
np.mean(eta, axis=0)

## if matplotlib is installed (optional, not required), a visual summary and
## traceplot are available
# fit.plot()
# plt.show()
```

### Stan

从 WinBUGS\index{WinBUGS} 到 OpenBUGS\index{OpenBUGS}，从 JAGS\index{JAGS} 到 Stan\index{Stan}，BUGS\index{BUGS}的发展从未停止过，Stan^[<http://mc-stan.org/>] 是一个统计建模和高性能统计计算平台。

Stan 提供的R语言接口 rstan 包 [@R-rstan] 及其扩展 StanHeaders 包 [@R-StanHeaders] 、bayesplot包 [@R-bayesplot] 、brms 包 [@brms2017JSS]、 rstanarm 包 [@R-rstanarm] 以及 rstan 的 wiki^[<https://github.com/stan-dev/rstan/wiki>] 及其在空间广义线性混合效应模型的参数估计和预测中的应用。


安装 rstan

```{r install-rstan, eval = (!"rstan" %in% .packages(TRUE))}
install.packages("rstan", dependencies = TRUE)
```

加载 rstan,如果你的电脑配置有多核处理器，内存也充足，那么可以考虑使用并行方式去估计你的模型参数，

```{r setup-rstan, eval = ("rstan" %in% .packages(TRUE))}
library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

安装 brms

```{r install-brms, eval = (!"brms" %in% .packages(TRUE))}
install.packages("brms", dependencies = TRUE)
```

安装 rstanarm

```{r install-rstanarm, eval = (!"rstanarm" %in% .packages(TRUE))}
install.packages("rstanarm", dependencies = TRUE)
```

1. Bayesian Data Analysis <https://github.com/avehtari/BDA_R_demos>
Bayesian Data Analysis, 3rd ed by Gelman, Carlin, Stern, Dunson, Vehtari, and Rubin (BDA3).

2. RStan Book <https://github.com/MatsuuraKentaro/RStanBook> 这是日文版

3. An Introduction to State Space Time Series Analysis <https://github.com/sinhrks/stan-statespace>
Stan models for state space time series

4. Draft introduction to probability and inference aimed at the Stan manual. <https://github.com/betanalpha/stan_intro>


5. Bayesian Modeling using Stan
<https://github.com/fonnesbeck/stan_workshop_2016>
Bayesian Modeling using Stan in R (May/June 2016)

6. Define Stan models using glmer-style (lme4) formulas
<https://github.com/rmcelreath/glmer2stan>

7. Examples of working and non-working models, initially for ODCS 2016 in Boston.
<https://github.com/sakrejda/stan-workshop>

8. State space models (dynamic linear models, hidden Markov models) implemented in Stan
<https://github.com/jrnold/ssmodels-in-stan>

9. State Space Models in Stan <https://jrnold.github.io/ssmodels-in-stan/>

10. Conditional autoregressive models in Stan <https://github.com/mbjoseph/CARstan>

11. Implementation of B-Splines in Stan <https://github.com/milkha/Splines_in_Stan>

12. <https://magesblog.com/post/correlated-lognormal-chain-ladder-model/>

