# 数值模拟

目前，在 R 语言中的空间数据分析和建模，包括空间插值和平滑以及克里金方法等，此外，还介绍了线性和混合线性模型，广义线性和广义线性混合效应的求解方法与软件实现[@MASS2002]。


`RandomFields` 是模拟多元随机场的 R 包 [@RandomFields2015]， `geoR` 包[@R-geoR2016]的 `grf` 函数只适合模拟少量数据点（$n < 500$）

分泊松、二项两种情况、上述3种方法，在空间广义线性混合效应模型下的模拟情况（使用标准的地统计模型，无时间项和混合分布）

## 二项分布

模型形式如方程 \@ref(eq:SGPSM)所示，也称为标准地质统计流行抽样模型（Standard Geostatistical Prevalence Sampling Model）

\begin{equation}
\log\big\{\frac{p(x_i)}{1-p(x_i)}\big\} = d(x_i)'\beta + S(x_i) + Z_i (\#eq:SGPSM)
\end{equation}

其中 $\mathcal{S} = \{S(x):x \in \mathbb{R}^2\}$


## 泊松分布

模型形式如方程 \@ref(eq:SGPSM2) 所示

\begin{equation}
\log[\lambda(x_i)] = d(x_i)'\beta + S(x_i) + Z_i (\#eq:SGPSM2)
\end{equation}



## 模拟二项分布数据集

此处模拟数据集 `data_sim` 来自 `PrevMap` 包，零均值高斯过程 单元格上 $30 \times 30$ 参数 
$\sigma^2 = 1, \phi = 0.15, \kappa =  2$，块金效应 (nugget effect) $\tau^2 = 0$，每个格点上重复实验10次，得到响应变量二项分布的概率值


```{r low-rank, fig.cap = "低秩近似方法与精确蒙特卡罗最大似然方法"}
knitr::include_graphics(path = "figures/simulation.pdf")
```

MCML 精确计算 
Low-Rank 近似计算 
贝叶斯MCMC计算(R和Stan) 
限制极大似然 REML 

## 广义线性模型

### 似然推断

```{r}
library(mcmc)
data(logit)
out <- glm(y ~ x1 + x2 + x3 + x4, data = logit,
    family = binomial(), x = TRUE)
summary(out)
```





### 贝叶斯推断

```{r}
x <- out$x
y <- out$y

lupost <- function(beta, x, y) {
    eta <- as.numeric(x %*% beta)
    logp <- ifelse(eta < 0, eta - log1p(exp(eta)), - log1p(exp(- eta)))
    logq <- ifelse(eta < 0, - log1p(exp(eta)), - eta - log1p(exp(- eta)))
    logl <- sum(logp[y == 1]) + sum(logq[y == 0])
    return(logl - sum(beta^2) / 8)
}
```


```{r}
set.seed(2018)    # to get reproducible results
beta.init <- as.numeric(coefficients(out))
out <- metrop(lupost, beta.init, 1e3, x = x, y = y)
names(out)
out$accept
```

```{r}
out <- metrop(out, scale = 0.1, x = x, y = y)
out$accept
out <- metrop(out, scale = 0.3, x = x, y = y)
out$accept
out <- metrop(out, scale = 0.5, x = x, y = y)
out$accept
out <- metrop(out, scale = 0.4, x = x, y = y)
out$accept
```

